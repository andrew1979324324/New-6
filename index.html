<!DOCTYPE html>
<html lang="it">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
Â  Â Â 
Â  Â  <meta name="mobile-web-app-capable" content="yes">
Â  Â  <meta name="apple-mobile-web-app-capable" content="yes">
Â  Â  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
Â  Â  <meta name="apple-mobile-web-app-title" content="Lavoro Pro">
Â  Â  <meta name="theme-color" content="#1a73e8">

Â  Â  <link rel="icon" type="image/png" href="https://i.ibb.co/0yCxc7hJ/logo.png">
Â  Â  <link rel="apple-touch-icon" href="https://i.ibb.co/0yCxc7hJ/logo.png">

Â  Â  <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIkxhdm9ybyBQcm8iLAogICJzaG9ydF9uYW1lIjogIkxhdm9ybyIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZjBmMmY1IiwKICAidGhlbWVfY29sb3IiOiAiIzFhNzNlOCIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImh0dHBzOi8vaS5pYmIuY28vMHlDeGM3aEovbG9nby5wbmciLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIsCiAgICAgICJwdXJwb3NlIjogImFueSBtYXNrYWJsZSIKICAgIH0sCiAgICB7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly9pLmliai5jby8weUN4YzdoSi9sb2dvLnBuZyIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaHR0cHM6Ly9pLmliai5jby8weUN4YzdoSi9sb2dvLnBuZyIsCiAgICAgICJwdXJwb3NlIjogImFueSBtYXNrYWJsZSIKICAgIH0KICBdCn0=">

Â  Â  <title>Lavoro Pro</title>

Â  Â  <style>
Â  Â  Â  Â  body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; text-align: center; background: #f0f2f5; color: #333; margin: 0; padding-bottom: 50px; -webkit-tap-highlight-color: transparent; }
Â  Â  Â  Â  .app-header { background: #1a73e8; color: white; padding: env(safe-area-inset-top) 15px 10px 15px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.2); position: sticky; top: 0; z-index: 100; }
Â  Â  Â  Â  .header-content { display: flex; align-items: center; gap: 12px; padding-top: 10px; }
Â  Â  Â  Â  .header-content img { height: 40px; width: 40px; border-radius: 8px; background: white; padding: 2px; }
Â  Â  Â  Â  #controls { margin: 15px; background: white; display: inline-flex; align-items: center; gap: 8px; padding: 5px 15px; border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #ddd; }
Â  Â  Â  Â  #calendar-container { max-width: 95%; margin: 0 auto; background: white; padding: 10px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
Â  Â  Â  Â  #week-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; font-weight: bold; margin-bottom: 8px; color: #5f6368; font-size: 0.65rem; text-transform: uppercase; }
Â  Â  Â  Â  #calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
Â  Â  Â  Â  .day { background: #fff; border: 1px solid #f0f0f0; border-radius: 8px; cursor: pointer; min-height: 70px; display: flex; flex-direction: column; font-size: 9px; overflow: hidden; position: relative; transition: 0.2s; }
Â  Â  Â  Â  .day.paid { background: #d1d1d1 !important; opacity: 0.6; text-decoration: line-through; filter: grayscale(1); border-left: 4px solid #666 !important; }
Â  Â  Â  Â  .day-number { font-weight: bold; font-size: 12px; padding: 4px; background: #fafafa; border-bottom: 1px solid #f0f0f0; }
Â  Â  Â  Â  .client-card { padding: 12px; border-radius: 12px; margin-top: 15px; transition: 0.3s; border: 1px solid rgba(0,0,0,0.05); }
Â  Â  Â  Â  .client-card.is-paid { background: #27ae60 !important; color: white !important; border-left: 8px solid #1e8449 !important; }
Â  Â  Â  Â  .invoice-row { background: rgba(255,255,255,0.7); padding: 10px; border-radius: 10px; margin-top: 8px; display: flex; align-items: center; gap: 15px; border: 1px solid rgba(0,0,0,0.1); color: #333; }
Â  Â  Â  Â  .invoice-row input[type="checkbox"] { width: 25px; height: 25px; margin: 0; cursor: pointer; }
Â  Â  Â  Â  .invoice-row input[type="text"] { margin: 0; padding: 8px; font-size: 14px; flex: 1; border-radius: 6px; border: 1px solid #ccc; }
Â  Â  Â  Â  button { padding: 14px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; width: 100%; font-size: 14px; margin-bottom: 8px; }
Â  Â  Â  Â  .btn-save { background: #1a73e8; color: white; }
Â  Â  Â  Â  .btn-close { background: #eee; color: #333; }
Â  Â  Â  Â  .loading-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; justify-content:center; align-items:center; flex-direction: column; }
Â  Â  Â  Â  .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #1a73e8; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
Â  Â  Â  Â  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
Â  Â  Â  Â  table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 10px; background: rgba(255,255,255,0.8); border-radius: 8px; color: #333; }
Â  Â  Â  Â  th, td { padding: 8px 4px; text-align: left; border-bottom: 1px solid rgba(0,0,0,0.05); }
Â  Â  Â  Â  #formBox, #summaryBox, #annualBox { display:none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 88%; max-width: 400px; max-height: 85vh; background:white; z-index: 1000; padding: 20px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.4); text-align: left; overflow-y: auto; }
Â  Â  </style>
</head>
<body>

<div id="loading" class="loading-overlay"><div class="spinner"></div><p>Sincronizzazione...</p></div>

<div class="app-header">
Â  Â  <div class="header-content">
Â  Â  Â  Â  <img src="https://i.ibb.co/0yCxc7hJ/logo.png" alt="Logo">
Â  Â  Â  Â  <div><h1 style="margin:0">Lavoro Pro</h1><div id="sync-status" style="font-size:10px">Pronto</div></div>
Â  Â  </div>
Â  Â  <button style="width:35px; height:35px; border-radius:50%; background:rgba(255,255,255,0.2); color:white; border:none;" onclick="loadFromCloud()">ğŸ”„</button>
</div>

<div id="controls">
Â  Â  <select id="monthSelect" style="width:auto; border:none; margin:0; font-weight:bold;"></select>
Â  Â  <select id="yearSelect" style="width:auto; border:none; margin:0; font-weight:bold;"></select>
</div>

<div id="calendar-container">
Â  Â  <div id="week-days"><div>Lun</div><div>Mar</div><div>Mer</div><div>Gio</div><div>Ven</div><div>Sab</div><div>Dom</div></div>
Â  Â  <div id="calendar"></div>
</div>

<div style="padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
Â  Â  <button class="btn-save" onclick="showSummary()">ğŸ“Š Consuntivo</button>
Â  Â  <button style="background:#f8f9fa; color:#1a73e8; border:1px solid #1a73e8;" onclick="showAnnualSummary()">ğŸ“ˆ Statistiche</button>
</div>

<div id="formBox">
Â  Â  <h3 id="selectedDate" style="margin-top:0; color:#1a73e8"></h3>
Â  Â  <label>SocietÃ </label><select id="client"></select>
Â  Â  <label>Location</label><select id="location" style="width:100%; padding:12px; margin:5px 0 12px 0; border:1px solid #ccc; border-radius:10px;"></select>
Â  Â  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
Â  Â  Â  Â  <div><label>Inizio</label><select id="startTime" style="width:100%; padding:12px; margin:5px 0 12px 0; border:1px solid #ccc; border-radius:10px;"></select></div>
Â  Â  Â  Â  <div><label>Fine</label><select id="endTime" style="width:100%; padding:12px; margin:5px 0 12px 0; border:1px solid #ccc; border-radius:10px;"></select></div>
Â  Â  </div>
Â  Â  <label>Pausa</label><select id="lunchBreak" style="width:100%; padding:12px; margin:5px 0 12px 0; border:1px solid #ccc; border-radius:10px;"><option value="si">SÃ¬</option><option value="no">No</option></select>
Â  Â  <div id="dayLiveRes" style="padding:10px; background:#e8f0fe; border-radius:10px; margin:10px 0; text-align:center; font-weight:bold; color:#1a73e8;"></div>
Â  Â  <button class="btn-save" onclick="saveData()">ğŸ’¾ Salva</button>
Â  Â  <button class="btn-close" onclick="closeAll()">Annulla</button>
Â  Â  <button id="deleteBtn" style="background:#fff1f0; color:#d93025; margin-top:10px;" onclick="deleteData()">ğŸ—‘ï¸ Elimina</button>
</div>

<div id="summaryBox">
Â  Â  <h3 id="summaryTitle" style="color:#1a73e8; margin-top:0;"></h3>
Â  Â  <div id="summaryContent"></div>
Â  Â  <button class="btn-save" style="background:#1d6f42; margin-top:20px;" onclick="exportCSV('tutti')">ğŸ’¾ Esporta CSV Mese</button>
Â  Â  <button class="btn-close" onclick="closeAll()">Chiudi</button>
</div>

<div id="annualBox">
Â  Â  <h3 id="annualTitle" style="color:#1a73e8; margin-top:0;"></h3>
Â  Â  <div id="annualContent"></div>
Â  Â  <button class="btn-close" style="margin-top:20px;" onclick="closeAll()">Chiudi</button>
</div>

<script>
// --- LOGICA APP ---
const CLOUD_URL = "https://script.google.com/macros/s/AKfycbyXnErX2Boa3_nAJgi1weV-Utx9WUPnZGuA9WV2_UwnQUpqJ2aNkK7YQeOKrgG8y-5d/exec";
const companies = ["Anteprima Video","Airone","Av Set","B-Nomio","Centro Pilota","Ciccarelli","Dafral Soundvision","De Simoni","Digital Network","DHS","F.A.R.E. Servizi","Gruppo Planet","HRC","Ifet","Livon","Lvs","Milani group","Mondialtecnica","Niutek","Onegroup","Sincronismi","Studiovisio","TCS 2000","Tecnoconference Roma","Tecnomeeting","Vms"];
const locations = ["Anantara","Angelicum","A. Roma Lifestyle","Acquario Romano","Auditorium P.d. Musica","Bernini Bristol","H. Massimo d'Azeglio","Cardo Roma","Chiostro Del Bramante","Don Giovanni (Praga)","Fao","Hotel Vanvitelli","Ergife Palace Hotel","Esperienza Europa","Eurostars Roma Aeterna","Fiera di Bologna","Hotel D. Camilla Savelli","H. BarcelÃ² Mantegna","H. Bulgari","H. Dei Mellini","H. Le Merdien Visconti","H. Parco de Principi","Hotel Plaza","Holiday Inn Rome","H. Rome Airport","H. Rome Eur La Lama","H. Nazionale","H. Ripa","Hotel Villa Pamphili","Boutique Calzavecchio","MOMEC","Nhow","Nh Centro","Nh Villa Carpegna","Nh Giustiniano","La Nuvola","Palazzo dell'INPS","Parlamento Europeo Italia","Rome Marriot P.H.","Rome Cavalieri","Salone delle Fontane","S. Rome P. De' Medici","StarHotels Metropole","Starhotels Excelsior (Bo)","StarHotels Michelangelo (Fi)","Spazio 900","Spazio Sette Libreria","The Hive Hotel","The Westin Warsaw","The Westin Excelsior Rome","The St. Regis Rome","The Space Cinema Moderno","Tempio di Adriano","Villa Miani","Studio Curtis","Villa Madama"];
const months = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];

let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();

window.onload = () => { setupSelects(); loadFromCloud(); };

function setupSelects() {
Â  Â  const mSel = document.getElementById("monthSelect"), ySel = document.getElementById("yearSelect");
Â  Â  companies.sort().forEach(c => document.getElementById("client").add(new Option(c, c)));
Â  Â  locations.sort().forEach(l => document.getElementById("location").add(new Option(l, l)));
Â  Â  months.forEach((m, i) => mSel.add(new Option(m, i)));
Â  Â  for(let y=2024; y<=2050; y++) ySel.add(new Option(y, y));
Â  Â  mSel.value = currentMonth; ySel.value = currentYear;
Â  Â  mSel.onchange = ySel.onchange = renderCalendar;
Â  Â  const sSel = document.getElementById("startTime"), eSel = document.getElementById("endTime");
Â  Â  for(let h=0; h<24; h++) ["00","30"].forEach(m => { let v=`${h.toString().padStart(2,'0')}:${m}`; sSel.add(new Option(v,v)); eSel.add(new Option(v,v)); });
Â  Â  document.querySelectorAll('#startTime, #endTime, #lunchBreak').forEach(el => el.onchange = updateLiveRes);
}

function getPaidKey(client) { return `PAID-${currentYear}-${currentMonth+1}-${client}`; }
function isPaid(client) { const data = JSON.parse(localStorage.getItem(getPaidKey(client))); return data ? data.paid : false; }

function renderCalendar() {
Â  Â  const cal = document.getElementById("calendar"); cal.innerHTML = "";
Â  Â  currentMonth = parseInt(document.getElementById("monthSelect").value);
Â  Â  currentYear = parseInt(document.getElementById("yearSelect").value);
Â  Â  const firstDay = new Date(currentYear, currentMonth, 1).getDay();
Â  Â  const offset = firstDay === 0 ? 6 : firstDay - 1;
Â  Â  const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
Â  Â  for(let i=0; i<offset; i++) cal.appendChild(Object.assign(document.createElement("div"), {className: "day empty"}));
Â  Â  for(let i=1; i<=daysInMonth; i++) {
Â  Â  Â  Â  const key = `${currentYear}-${currentMonth+1}-${i}`, data = JSON.parse(localStorage.getItem(key)), div = document.createElement("div");
Â  Â  Â  Â  div.className = "day"; div.onclick = () => openDay(i); div.innerHTML = `<div class="day-number">${i}</div>`;
Â  Â  Â  Â  if(data) {
Â  Â  Â  Â  Â  Â  if(isPaid(data.client)) div.classList.add("paid");
Â  Â  Â  Â  Â  Â  const color = getColor(data.client); div.style.background = color;
Â  Â  Â  Â  Â  Â  div.style.borderLeft = `4px solid ${color.replace('85%','40%')}`;
Â  Â  Â  Â  Â  Â  div.innerHTML += `<div style="font-weight:bold; padding:2px; margin-top:2px;">${data.client.substring(0,8)}..</div>`;
Â  Â  Â  Â  }
Â  Â  Â  Â  cal.appendChild(div);
Â  Â  }
}

async function loadFromCloud() {
Â  Â  toggleLoading(true);
Â  Â  try {
Â  Â  Â  Â  const response = await fetch(CLOUD_URL); const cloudData = await response.json();
Â  Â  Â  Â  Object.keys(localStorage).forEach(k => { if(k.match(/^\d{4}-|PAID-/) ) localStorage.removeItem(k); });
Â  Â  Â  Â  Object.keys(cloudData).forEach(k => localStorage.setItem(k, JSON.stringify(cloudData[k])));
Â  Â  Â  Â  document.getElementById('sync-status').innerText = "Sincronizzato âœ…"; renderCalendar();
Â  Â  } catch (e) { document.getElementById('sync-status').innerText = "Offline âŒ"; }
Â  Â  finally { toggleLoading(false); }
}

async function syncToCloud() {
Â  Â  toggleLoading(true); const allData = {};
Â  Â  Object.keys(localStorage).forEach(k => { if(k.match(/^\d{4}-|PAID-/)) allData[k] = JSON.parse(localStorage.getItem(k)); });
Â  Â  try { await fetch(CLOUD_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "save", db: JSON.stringify(allData) }) });
Â  Â  document.getElementById('sync-status').innerText = "Salvato Cloud â˜ï¸"; } catch (e) { alert("Errore Cloud"); }
Â  Â  finally { toggleLoading(false); }
}

function showSummary() {
Â  Â  let html = ""; const dataByClient = {};
Â  Â  for(let i=1; i<=31; i++) {
Â  Â  Â  Â  const d = JSON.parse(localStorage.getItem(`${currentYear}-${currentMonth+1}-${i}`));
Â  Â  Â  Â  if(d) { if(!dataByClient[d.client]) dataByClient[d.client] = []; dataByClient[d.client].push({day: i, ...d}); }
Â  Â  }
Â  Â  for(let client in dataByClient) {
Â  Â  Â  Â  let sub = 0; const color = getColor(client), pKey = getPaidKey(client), pData = JSON.parse(localStorage.getItem(pKey)) || { invoice: "", paid: false };
Â  Â  Â  Â  html += `<div class="client-card ${pData.paid ? 'is-paid' : ''}" style="background:${color}; border-left: 6px solid ${color.replace('85%','45%')}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display:flex; justify-content:space-between; align-items:center; font-weight:bold;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size:16px;">${client} ${pData.paid ? 'âœ…' : ''}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-excel-small" style="width:auto; padding:5px 10px; font-size:10px; background:#1d6f42; color:white; border-radius:6px;" onclick="exportCSV('${client.replace(/'/g, "\\'")}')">CSV</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="invoice-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="inv-${client}" placeholder="Fattura n." value="${pData.invoice}" onchange="saveInvoiceData('${client}')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label><input type="checkbox" id="pay-${client}" ${pData.paid ? 'checked' : ''} onchange="saveInvoiceData('${client}')"> PAGATA</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â </div><table><tr><th>G</th><th>Location</th><th>Stra</th><th>Lordo</th></tr>`;
Â  Â  Â  Â  dataByClient[client].forEach(item => {
Â  Â  Â  Â  Â  Â  const s = getStats(item.startTime, item.endTime, item.lunchBreak);
Â  Â  Â  Â  Â  Â  html += `<tr><td>${item.day}</td><td>${item.location.substring(0,12)}</td><td>${s.stra.toFixed(1)}</td><td>â‚¬${s.lordo.toFixed(0)}</td></tr>`;
Â  Â  Â  Â  Â  Â  sub += s.lordo;
Â  Â  Â  Â  });
Â  Â  Â  Â  html += `<tr style="font-weight:bold; background:rgba(0,0,0,0.1);"><td colspan="3">TOTALE</td><td>â‚¬${sub.toFixed(2)}</td></tr></table>`;
Â  Â  }
Â  Â  document.getElementById("summaryTitle").innerText = `${months[currentMonth]} ${currentYear}`;
Â  Â  document.getElementById("summaryContent").innerHTML = html || "<p style='text-align:center'>Nessun dato.</p>";
Â  Â  document.getElementById("summaryBox").style.display = "block";
}

async function saveInvoiceData(client) {
Â  Â  const inv = document.getElementById(`inv-${client}`).value;
Â  Â  const paid = document.getElementById(`pay-${client}`).checked;
Â  Â  localStorage.setItem(getPaidKey(client), JSON.stringify({ invoice: inv, paid: paid }));
Â  Â  showSummary(); renderCalendar(); await syncToCloud();
}

function exportCSV(target) {
Â  Â  let csv = "\ufeffSocietÃ ;Data;Location;Inizio;Fine;Pausa;Straordinari;Lordo\n"; let grandTotal = 0;
Â  Â  for(let i=1; i<=31; i++) {
Â  Â  Â  Â  const d = JSON.parse(localStorage.getItem(`${currentYear}-${currentMonth+1}-${i}`));
Â  Â  Â  Â  if(d && (target === 'tutti' || d.client === target)) {
Â  Â  Â  Â  Â  Â  const s = getStats(d.startTime, d.endTime, d.lunchBreak);
Â  Â  Â  Â  Â  Â  csv += `${d.client};${i}/${currentMonth+1}/${currentYear};${d.location};${d.startTime};${d.endTime};${d.lunchBreak};${s.stra.toFixed(1)};${s.lordo.toFixed(2)}\n`;
Â  Â  Â  Â  Â  Â  grandTotal += s.lordo;
Â  Â  Â  Â  }
Â  Â  }
Â  Â  csv += `\n;;;;;;TOTALE LORDO;${grandTotal.toFixed(2)}`;
Â  Â  const blob = new Blob([csv], {type: 'text/csv;charset=utf-8'}); const link = document.createElement("a");
Â  Â  link.href = URL.createObjectURL(blob); link.download = `Consuntivo_${target.replace(/\s+/g,'_')}.csv`; link.click();
}

function getStats(start, end, lunch) {
Â  Â  const s = new Date(`1970-01-01T${start}`), e = new Date(`1970-01-01T${end}`);
Â  Â  let diff = (e - s) / 3600000; if (diff < 0) diff += 24;
Â  Â  const stra = Math.max(0, diff - (lunch === 'no' ? 8 : 9));
Â  Â  const lordo = 250 + (stra * 25); return { stra, lordo, netto: lordo * 0.74 };
}

function openDay(day) {
Â  Â  const key = `${currentYear}-${currentMonth+1}-${day}`;
Â  Â  document.getElementById("formBox").style.display = "block"; document.getElementById("formBox").dataset.key = key;
Â  Â  document.getElementById("selectedDate").innerText = `${day} ${months[currentMonth]} ${currentYear}`;
Â  Â  const data = JSON.parse(localStorage.getItem(key));
Â  Â  if(data) {
Â  Â  Â  Â  document.getElementById("client").value = data.client; document.getElementById("location").value = data.location;
Â  Â  Â  Â  document.getElementById("startTime").value = data.startTime; document.getElementById("endTime").value = data.endTime;
Â  Â  Â  Â  document.getElementById("lunchBreak").value = data.lunchBreak || 'si'; document.getElementById("deleteBtn").style.display = "block";
Â  Â  } else {
Â  Â  Â  Â  document.getElementById("startTime").value = "08:30"; document.getElementById("endTime").value = "17:30";
Â  Â  Â  Â  document.getElementById("lunchBreak").value = "si"; document.getElementById("deleteBtn").style.display = "none";
Â  Â  }
Â  Â  updateLiveRes();
}

function updateLiveRes() {
Â  Â  const s = getStats(document.getElementById("startTime").value, document.getElementById("endTime").value, document.getElementById("lunchBreak").value);
Â  Â  document.getElementById("dayLiveRes").innerText = `Lordo: â‚¬${s.lordo.toFixed(2)} | Stra: ${s.stra.toFixed(1)}h`;
}

async function saveData() {
Â  Â  const key = document.getElementById("formBox").dataset.key;
Â  Â  const data = { client: document.getElementById("client").value, location: document.getElementById("location").value, startTime: document.getElementById("startTime").value, endTime: document.getElementById("endTime").value, lunchBreak: document.getElementById("lunchBreak").value };
Â  Â  localStorage.setItem(key, JSON.stringify(data)); await syncToCloud(); closeAll(); renderCalendar();
}

async function deleteData() { if(confirm("Eliminare?")) { localStorage.removeItem(document.getElementById("formBox").dataset.key); await syncToCloud(); closeAll(); renderCalendar(); } }

function showAnnualSummary() {
Â  Â  let totalNetto = 0, totalGG = 0; const statsByClient = {};
Â  Â  Object.keys(localStorage).forEach(k => {
Â  Â  Â  Â  if(k.startsWith(`${currentYear}-`)) {
Â  Â  Â  Â  Â  Â  const d = JSON.parse(localStorage.getItem(k)), s = getStats(d.startTime, d.endTime, d.lunchBreak);
Â  Â  Â  Â  Â  Â  totalNetto += s.netto; totalGG++;
Â  Â  Â  Â  Â  Â  if(!statsByClient[d.client]) statsByClient[d.client] = { days: 0, lordo: 0 };
Â  Â  Â  Â  Â  Â  statsByClient[d.client].days++; statsByClient[d.client].lordo += s.lordo;
Â  Â  Â  Â  }
Â  Â  });
Â  Â  let clientHtml = '';
Â  Â  Object.entries(statsByClient).sort((a,b)=>b[1].days-a[1].days).forEach(([name, data]) => {
Â  Â  Â  Â  const color = getColor(name);
Â  Â  Â  Â  clientHtml += `<div style="display:flex; justify-content:space-between; align-items:center; background:white; margin-bottom:6px; padding:10px; border-radius:10px; border-left:5px solid ${color.replace('85%','45%')};">
Â  Â  Â  Â  Â  Â  Â  Â  <div><div style="font-weight:bold; font-size:13px;">${name}</div><div style="font-size:10px; color:#666;">Lordo: â‚¬${data.lordo.toFixed(0)}</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="background:#e8f0fe; color:#1a73e8; padding:4px 10px; border-radius:20px; font-weight:bold;">${data.days} gg</div>
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  });
Â  Â  document.getElementById("annualTitle").innerText = `Statistiche ${currentYear}`;
Â  Â  document.getElementById("annualContent").innerHTML = `<div style="background:#f8f9fa; padding:15px; border-radius:15px;">
Â  Â  Â  Â  <p>Giorni: <b>${totalGG}</b></p><p>Netto: <b>â‚¬${totalNetto.toFixed(2)}</b></p>${clientHtml}</div>`;
Â  Â  document.getElementById("annualBox").style.display = "block";
}

function getColor(n) { let h = 0; for (let i = 0; i < n.length; i++) h = n.charCodeAt(i) + ((h << 5) - h); return `hsl(${Math.abs(h) % 360}, 75%, 85%)`; }
function toggleLoading(s) { document.getElementById("loading").style.display = s ? "flex" : "none"; }
function closeAll() { document.getElementById("formBox").style.display = "none"; document.getElementById("summaryBox").style.display = "none"; document.getElementById("annualBox").style.display = "none"; }

// --- REGISTRAZIONE SERVICE WORKER (FONDAMENTALE PER PWA) ---
if ('serviceWorker' in navigator) {
Â  navigator.serviceWorker.register('sw.js');
}
</script>
</body>
</html>
